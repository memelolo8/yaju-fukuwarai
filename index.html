<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>究極の福笑い - 超スムーズ版</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: 'Meiryo', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            overflow: hidden; /* 画面全体の揺れを防止 */
            touch-action: none;
        }

        h1 { font-size: 1.2rem; margin: 10px 0; color: #ffcc00; }

        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            width: 100%;
        }
        @media (min-width: 900px) {
            .main-layout { flex-direction: row; align-items: flex-start; justify-content: center; }
        }

        #game-board {
            position: relative;
            width: 95vw;
            height: 105vw;
            max-width: 600px;
            max-height: 650px;
            background: #333;
            border: 4px solid #555;
            border-radius: 15px;
            overflow: hidden;
            background-image: radial-gradient(circle, #444 0%, #222 100%);
        }

        .sample-container {
            width: 80vw;
            max-width: 250px;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 10px;
            border: 2px dashed #666;
            text-align: center;
        }
        #sample-image { width: 100%; border-radius: 5px; pointer-events: none; }

        #base-face {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            opacity: 0.7;
            pointer-events: none;
        }

        .part {
            position: absolute;
            cursor: grab;
            z-index: 10;
            width: 18%;
            /* 動きを滑らかにする魔法のプロパティ */
            touch-action: none;
            user-select: none;
            -webkit-user-drag: none;
            will-change: transform;
        }
        .part:active { cursor: grabbing; z-index: 100; }

        /* 初期位置 */
        #eye_left   { top: 5%; left: 5%; }
        #eye_right  { top: 5%; left: 25%; }
        #brow_left  { top: 5%; left: 45%; }
        #brow_right { top: 5%; left: 65%; }
        #nose       { top: 15%; left: 5%; width: 12%; }
        #mouth      { top: 15%; left: 25%; width: 22%; }

        .controls { margin-top: 20px; }
        button {
            padding: 12px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(to bottom, #ffcc00, #ff9900);
            border: none;
            border-radius: 30px;
            cursor: pointer;
        }
        #result { font-size: 1.8rem; margin-top: 10px; color: #00ffcc; font-weight: bold; }
    </style>
</head>
<body>

    <h1>究極の福笑い</h1>
    
    <div class="main-layout">
        <div id="game-board">
            <img src="base.png" id="base-face" draggable="false">
            <img src="eye_left.png"   id="eye_left"   class="part" draggable="false">
            <img src="eye_right.png"  id="eye_right"  class="part" draggable="false">
            <img src="brow_left.png"  id="brow_left"  class="part" draggable="false">
            <img src="brow_right.png" id="brow_right" class="part" draggable="false">
            <img src="nose.png"       id="nose"       class="part" draggable="false">
            <img src="mouth.png"      id="mouth"      class="part" draggable="false">
        </div>

        <div class="sample-container">
            <h3 style="margin:0; font-size: 0.9rem; color: #00ffcc;">お手本</h3>
            <img src="sample.png" id="sample-image" draggable="false">
        </div>
    </div>

    <div class="controls">
        <button onclick="calculateScore()">採点する！</button>
        <div id="result">完成度: -- %</div>
    </div>

    <script>
        const correctRatio = {
            eye_left:   { x: 0.40, y: 0.47 },
            eye_right:  { x: 0.60, y: 0.47 },
            brow_left:  { x: 0.40, y: 0.40 },
            brow_right: { x: 0.60, y: 0.40 },
            nose:       { x: 0.50, y: 0.60 },
            mouth:      { x: 0.50, y: 0.75 }
        };

        let activePart = null;
        let startPos = { x: 0, y: 0 };
        let currentPos = { x: 0, y: 0 };

        function startDrag(e) {
            e.preventDefault();
            activePart = e.target;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // 現在のtransformの値を取得
            const style = window.getComputedStyle(activePart);
            const matrix = new WebKitCSSMatrix(style.transform);
            
            startPos.x = clientX - matrix.m41;
            startPos.y = clientY - matrix.m42;
        }

        function moveDrag(e) {
            if (!activePart) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - startPos.x;
            const y = clientY - startPos.y;

            // top/leftではなくtransformを使うことで爆速になります
            activePart.style.transform = `translate(${x}px, ${y}px)`;
        }

        function endDrag() { activePart = null; }

        document.querySelectorAll('.part').forEach(part => {
            part.addEventListener('mousedown', startDrag);
            part.addEventListener('touchstart', startDrag, {passive: false});
        });

        document.addEventListener('mousemove', moveDrag, {passive: false});
        document.addEventListener('touchmove', moveDrag, {passive: false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        function calculateScore() {
            let totalDiff = 0;
            const board = document.getElementById('game-board').getBoundingClientRect();
            
            Object.keys(correctRatio).forEach(id => {
                const el = document.getElementById(id);
                const rect = el.getBoundingClientRect();
                const curX = (rect.left - board.left + rect.width / 2) / board.width;
                const curY = (rect.top - board.top + rect.height / 2) / board.height;

                const dx = curX - correctRatio[id].x;
                const dy = curY - correctRatio[id].y;
                totalDiff += Math.sqrt(dx * dx + dy * dy);
            });

            const score = Math.max(0, 100 - Math.floor((totalDiff / 6) * 500));
            document.getElementById('result').innerText = `完成度: ${score}%`;
            if(score === 100) alert("完璧です！");
        }
    </script>
</body>
</html>
